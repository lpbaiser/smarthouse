<html>

<head>
  <title>Controle</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
</head>

<body>
  <div class="container">

    <div class="col-md-12">
      <div class="col-md-4">
        <h3>Controles do sistema</h3>
      </div>
      <div class="col-md-4 bg-warning" id='disparoAlarme'>
          Alarme inativo
        </div>

      <div class="col-md-4">
        <div class="col-md-8">
          <h4>Temperatura ambiente: </h4>
        </div>
        <div class="col-md-4">
          <h4 id='temperatura'></h4>
        </div>
      </div>
    </div>

    <div class="col-md-12">
      <div class="col-md-2">
        <a id="alarm" onclick="funcStopAlarme.call(this)" class="btn btn-success" style="width:100%">Ativar alarme</a>
      </div>
      <div class="col-md-2">
        <a id="portao" onclick="funcPortao.call(this)" class="btn btn-success" style="width:100%">Abrir portão</a>
      </div>
      <div class="col-md-2">
        <a id="porta" onclick="funcPorta.call(this)" class="btn btn-success" style="width:100%">Abrir porta</a>
      </div>
      <div class="col-md-2">
        <a id="logs" onclick="getLogs.call(this)" class="btn btn-success" style="width:100%">Ver logs</a>
      </div>
      <div class="col-md-2">
        <a id="ventilador" onclick="funcVentilador.call(this)" class="btn btn-success" style="width:100%">Ligar ventilador</a>
      </div>
      <div class="col-md-2">
        <a id="led" onclick="funcLed.call(this)" class="btn btn-success" style="width:100%">Ligar led</a>
      </div>
    </div>

    <div class="col-md-6">
      <div id="tabela1"></div>
    </div>
    <div class="col-md-6">
      <div id="tabela2"></div>
    </div>
  </div>

  <script type="text/javascript">
    let xmlHttp = new XMLHttpRequest();
    let idLogin = localStorage.getItem('idlogin');
    let controlePortao = 1;
    let controlePorta = 1;
    let controleAlarme = 1;
    let controleVentilador = 1;
    let controleLed = 1;
    function funcPortao() {
      xmlHttp.open("POST", "/portao", true);
      let action = {
        controlePortao: controlePortao,
        idLogin: idLogin
      }
      xmlHttp.send(JSON.stringify(action));
      $(this).toggleClass('btn-warning');
      if (controlePortao == 1) {
        $(this).text('Fechar portão');
        controlePortao = 0;
      } else {
        controlePortao = 1;
        $(this).text('Abrir portão');
      }
    };

    function funcPorta() {
      xmlHttp.open("POST", "/porta", true);

      let action = {
        controlePorta: controlePorta,
        idLogin: idLogin
      }
      xmlHttp.send(JSON.stringify(action));
      $(this).toggleClass('btn-warning');
      if (controlePorta == 1) {
        $(this).text('Fechar porta');
        controlePorta = 0;
      } else {
        controlePorta = 1;
        $(this).text('Abrir porta');
      }
    };

    function funcStopAlarme() {
      let action = {
        controleAlarme: controleAlarme,
        idLogin: idLogin
      }
      xmlHttp.open("POST", "/alarme", true);
      xmlHttp.send(JSON.stringify(action));
      $(this).toggleClass('btn-warning');
      if (controleAlarme == 1) {
        $(this).text('Desativar alarme');
        controleAlarme = 0;
        document.getElementById("disparoAlarme").innerHTML = 'Alarme ativo';
        document.getElementById("disparoAlarme").className = 'col-md-4 bg-primary';
      } else {
        controleAlarme = 1;
        $(this).text('Ativar alarme');
        document.getElementById("disparoAlarme").innerHTML = 'Alarme inativo';
        document.getElementById("disparoAlarme").className = 'col-md-4 bg-warning';
      }
    }

    function funcVentilador() {
      xmlHttp.open("POST", "/ventilador", true);
      let action = {
        controleVentilador: controleVentilador,
        idLogin: idLogin
      }
      xmlHttp.send(JSON.stringify(action));
      $(this).toggleClass('btn-warning');
      if (controleVentilador == 1) {
        $(this).text('Desligar ventilador');
        controleVentilador = 0;
      } else {
        controleVentilador = 1;
        $(this).text('Ligar ventilador');
      }
    };

    function funcLed() {
      xmlHttp.open("POST", "/led", true);
      let action = {
        controleLed: controleLed,
        idLogin: idLogin
      }
      xmlHttp.send(JSON.stringify(action));
      $(this).toggleClass('btn-warning');
      if (controleLed == 1) {
        $(this).text('Desligar led');
        controleLed = 0;
      } else {
        controleLed = 1;
        $(this).text('Ligar led ');
      }
    };

    function postLogin() {
      xmlHttp.open("POST", '/index', true); // true for asynchronous 
      xmlHttp.send(JSON.stringify({ idlogin: localStorage.getItem(idlogin) }));
    }

    function getTemperatura() {
      let myJson, temperatura;
      xmlHttp.open("POST", '/temperatura', true);
      xmlHttp.send(null);
      xmlHttp.onreadystatechange = function () {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
          myJson = JSON.parse(xmlHttp.responseText);
          temperatura = myJson.temperatura;
          document.getElementById("temperatura").innerHTML = temperatura + '˚C';
        }
      }
    }

    function getDisparoAlarme() {
      let myJson, disparoAlarme;
      xmlHttp.open("POST", '/disparoAlarme', true);
      xmlHttp.send(null);
      xmlHttp.onreadystatechange = function () {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
          myJson = JSON.parse(xmlHttp.responseText);
          disparoAlarme = myJson.disparoAlarme;
          if (disparoAlarme == true){
            document.getElementById("disparoAlarme").innerHTML = 'Alarme disparou';
            document.getElementById("disparoAlarme").className = 'col-md-4 bg-danger';
          }
        }
      }
    }

    function getLogs() {
      document.getElementById("tabela1").innerHTML = 'tabela1';
      xmlHttp.open("GET", '/getLogs', true); // true for asynchronous 
      xmlHttp.send(null);
      var myObj, tabela1 = '', tabela2 = '', myJson;
      xmlHttp.onreadystatechange = function () {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
          myJson = JSON.parse(xmlHttp.responseText);
          myObj = myJson.logs;
          if (myObj.length > 0) {
            tabela1 += "<table class='table' border='1'>"
            tabela2 += "<table class='table' border='1'>"
            tabela1 += "<th> LOGIN</th>"
            tabela2 += "<th> LOGIN</th>"
            tabela1 += "<th> AÇÃO</th>"
            tabela2 += "<th> AÇÃO</th>"
            tabela1 += "<th> TIPO</th>"
            tabela2 += "<th> TIPO</th>"
            tabela1 += "<th> DATA</th>"
            tabela2 += "<th> DATA</th>"
            myObj.map(function (item, index) {
              if (item.tipo === 'PORTAO') {
                tabela1 += "<tr><td>" + item.idlogin + "</td>";
                tabela1 += "<td>" + item.acao + "</td>";
                tabela1 += "<td>" + item.tipo + "</td>";
                tabela1 += "<td>" + moment.tz(item.data, 'America/Sao_Paulo').format('DD/MM/YYYY - hh:mm:ss') + "</td></tr>";
              } else {
                tabela2 += "<tr><td>" + item.idlogin + "</td>";
                tabela2 += "<td>" + item.acao + "</td>";
                tabela2 += "<td>" + item.tipo + "</td>";
                tabela2 += "<td>" + moment.tz(item.data, 'America/Sao_Paulo').format('DD/MM/YYYY - hh:mm:ss') + "</td></tr>";
              }
            })
            tabela1 += "</table>"
            console.log('tabela1', tabela1)
            document.getElementById("tabela1").innerHTML = tabela1;
            document.getElementById("tabela2").innerHTML = tabela2;
          }
        }
      }
    };

    setInterval(() => {
      getTemperatura();
    }, 60000)//atualiza temperatura a cada minuto;

    setInterval(() => {
      getDisparoAlarme();
    }, 1000)//verifica se alarme disparou a cada 1 segundo

    window.onload = getTemperatura();
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <!-- <script src="https://momentjs.com/downloads/moment.js"></script> -->
  <script src="https://momentjs.com/downloads/moment-timezone.js"></script>
</body>

</html>